[gd_scene load_steps=10 format=2]

[ext_resource path="res://turbine.tscn" type="PackedScene" id=1]
[ext_resource path="res://house.tscn" type="PackedScene" id=2]
[ext_resource path="res://SolarPanel.tscn" type="PackedScene" id=3]

[sub_resource type="CubeMesh" id=1]

[sub_resource type="BoxShape" id=2]

[sub_resource type="GDScript" id=3]
script/source = "extends KinematicBody

const GRAVITY = -9.8
const JUMP_FORCE = 10
const MOVE_SPEED = 10
const MOUSE_SENSITIVITY = 0.1
const MAX_FALL_SPEED = 50

var velocity = Vector3.ZERO
var direction = Vector3.ZERO
var jump = false

var camera
var y_rotation = 0

# New variables for instancing
var scene_to_place = preload(\"res://SolarPanel.tscn\") # Preload the scene
var instance_ready_to_place = false

func _ready():
	camera = $Camera
	Input.set_mouse_mode(Input.MOUSE_MODE_CAPTURED)

func _unhandled_input(event):
	if event is InputEventMouseMotion:
		rotation.y -= event.relative.x * MOUSE_SENSITIVITY
		y_rotation -= event.relative.y * MOUSE_SENSITIVITY
		y_rotation = clamp(y_rotation, -90, 90)
		camera.rotation_degrees.x = y_rotation
	
	if event is InputEventMouseButton:
		if event.button_index == BUTTON_LEFT and instance_ready_to_place:
			place_instance()

func _physics_process(delta):
	handle_movement(delta)
	#print(instance_ready_to_place)
	
	# Detect F key press
	if Input.is_action_just_pressed(\"ui_place\"):
		instance_ready_to_place = true # Enable placement mode

func handle_movement(delta):
	direction = Vector3.ZERO

	if Input.is_action_pressed(\"ui_up\"):
		direction += transform.basis.z
	if Input.is_action_pressed(\"ui_down\"):
		direction -= transform.basis.z
	if Input.is_action_pressed(\"ui_left\"):
		direction += transform.basis.x
	if Input.is_action_pressed(\"ui_right\"):
		direction -= transform.basis.x

	direction = direction.normalized()
	velocity.y += GRAVITY * delta

	if is_on_floor():
		if Input.is_action_just_pressed(\"ui_jump\"):
			velocity.y = JUMP_FORCE

	var horizontal_velocity = direction * MOVE_SPEED
	horizontal_velocity.y = velocity.y
	velocity = move_and_slide(horizontal_velocity, Vector3.UP)
	
	if velocity.y < -MAX_FALL_SPEED:
		velocity.y = -MAX_FALL_SPEED

func place_instance():
	# Perform a raycast from the camera to a fixed distance (end of ray)
	var ray_origin = camera.global_transform.origin
	var ray_direction = -camera.global_transform.basis.z.normalized() * 10

	# Calculate the end point of the ray (instead of where the ray hits)
	var ray_end = ray_origin + ray_direction

	# Create an instance of the scene
	var instance = scene_to_place.instance()
	
	# Place it at the end of the ray
	instance.global_transform.origin = ray_end
	get_parent().add_child(instance) # Add the instance to the scene

	# Adjust position after instancing (optional):
	# Example: Move the instance slightly back from the ray end (closer to the player)
	var adjustment = Vector3(0, 0, -5) # Adjust it by 5 units backward along the Z axis
	instance.global_transform.origin += adjustment
	instance.scale.x = 4.5
	instance.scale.y = 4.5
	instance.scale.z = 4.5

	# Reset placement mode
	instance_ready_to_place = false

"

[sub_resource type="BoxShape" id=4]

[sub_resource type="SpatialMaterial" id=5]
albedo_color = Color( 0.25098, 0.964706, 0.0745098, 1 )

[sub_resource type="CapsuleMesh" id=6]
material = SubResource( 5 )

[node name="world" type="Spatial"]

[node name="land" type="StaticBody" parent="."]
transform = Transform( 50, 0, 0, 0, 1, 0, 0, 0, 50, 0, 0, 0 )

[node name="MeshInstance" type="MeshInstance" parent="land"]
mesh = SubResource( 1 )
material/0 = null

[node name="CollisionShape" type="CollisionShape" parent="land"]
shape = SubResource( 2 )

[node name="jeff" type="KinematicBody" parent="."]
transform = Transform( 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 4.12696, 10.9699 )
script = SubResource( 3 )

[node name="CollisionShape" type="CollisionShape" parent="jeff"]
transform = Transform( 1, 0, 0, 0, -6.15154e-08, -1.40731, 0, 1, -4.37114e-08, 0, 0, 0 )
shape = SubResource( 4 )

[node name="MeshInstance" type="MeshInstance" parent="jeff"]
transform = Transform( 1, 0, 0, 0, -4.37114e-08, -1, 0, 1, -4.37114e-08, 0, 0, 0 )
mesh = SubResource( 6 )
material/0 = null

[node name="Camera" type="Camera" parent="jeff"]
transform = Transform( -1, 0, -8.74228e-08, 0, 1, 0, 8.74228e-08, 0, -1, 0, 1.35706, -0.318151 )

[node name="building-sample-house-c" parent="." instance=ExtResource( 2 )]
transform = Transform( 8, 0, 0, 0, 8, 0, 0, 0, 8, 5.15056, 1.20079, -8.93666 )

[node name="Solar Panel" parent="." instance=ExtResource( 3 )]
transform = Transform( 4.5, 0, 0, 0, 4.5, 0, 0, 0, 4.5, 15.5218, 0.86904, 3.99975 )

[node name="uploads_files_2424344_Windturbine" parent="." instance=ExtResource( 1 )]
transform = Transform( 0.2, 0, 0, 0, 0.2, 0, 0, 0, 0.2, 19.3324, 1.28245, 6.03852 )
